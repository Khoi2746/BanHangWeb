<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Theo dõi đơn hàng | Nike Store</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- NIKE STYLE CSS --- */
        body { font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; background-color: #f5f5f5; margin: 0; padding: 0; }
        
        .tracking-container {
            max-width: 900px;
            margin: 40px auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        .header-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e5e5e5;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }

        .header-section h2 { margin: 0; font-size: 24px; font-weight: 700; text-transform: uppercase; }
        .order-id { color: #757575; font-size: 16px; }

        /* --- THANH TIẾN TRÌNH (PROGRESS BAR) --- */
        .progress-track {
            display: flex;
            justify-content: space-between;
            margin-bottom: 40px;
            position: relative;
        }

        /* Đường kẻ mờ phía sau */
        .progress-track::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 0;
            width: 100%;
            height: 4px;
            background: #e5e5e5;
            z-index: 1;
        }

        .step {
            position: relative;
            z-index: 2;
            text-align: center;
            width: 33.33%;
        }

        .step-icon {
            width: 34px;
            height: 34px;
            background: #e5e5e5;
            color: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px auto;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .step-text { font-size: 14px; color: #757575; font-weight: 500; }

        /* Trạng thái Active (Đã hoàn thành) */
        .step.active .step-icon { background: #111; box-shadow: 0 0 0 4px #fff; } /* Màu đen Nike */
        .step.active .step-text { color: #111; font-weight: 700; }

        /* --- THÔNG TIN VẬN CHUYỂN --- */
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        .info-box { background: #f9f9f9; padding: 15px; border-radius: 8px; }
        .info-label { font-size: 12px; color: #757575; margin-bottom: 5px; text-transform: uppercase; }
        .info-value { font-size: 16px; font-weight: 600; color: #111; }

        /* --- BẢN ĐỒ --- */
        #map {
            height: 450px;
            width: 100%;
            border-radius: 12px;
            border: 1px solid #ddd;
            z-index: 0; /* Để không che menu dropdown nếu có */
        }
        
        .btn-back {
            display: inline-block;
            margin-top: 20px;
            text-decoration: none;
            color: #111;
            font-weight: 600;
            font-size: 14px;
        }
        .btn-back:hover { text-decoration: underline; }

    </style>
</head>
<body>

<div class="tracking-container">
    <div class="header-section">
        <h2>Tracking Order</h2>
        <span class="order-id">Mã đơn: #<span th:text="${order.id}"></span></span>
    </div>

    <div class="progress-track">
        <div class="step active">
            <div class="step-icon"><i class="fa-solid fa-receipt"></i></div>
            <div class="step-text">Chờ xác nhận</div>
        </div>

        <div class="step" th:classappend="${order.status == 'Shipping' || order.status == 'Delivered' ? 'active' : ''}">
            <div class="step-icon"><i class="fa-solid fa-truck-fast"></i></div>
            <div class="step-text">Đang giao hàng</div>
        </div>

        <div class="step" th:classappend="${order.status == 'Delivered' ? 'active' : ''}">
            <div class="step-icon"><i class="fa-solid fa-check"></i></div>
            <div class="step-text">Đã giao hàng</div>
        </div>
    </div>

    <div class="info-grid">
        <div class="info-box">
            <div class="info-label">Địa chỉ nhận hàng</div>
            <div class="info-value" id="customer-address" th:text="${order.address}">25, đường 19, Thủ Đức</div>
        </div>
        <div class="info-box">
            <div class="info-label">Tổng thanh toán</div>
            <div class="info-value" th:text="${#numbers.formatDecimal(order.totalAmount, 0, 'COMMA', 0, 'POINT')} + '₫'">1.250.000₫</div>
        </div>
    </div>

    <div id="map"></div>
    
    <a href="/" class="btn-back"><i class="fa-solid fa-arrow-left"></i> Quay lại trang chủ</a>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script th:inline="javascript">
    document.addEventListener("DOMContentLoaded", function() {
        // --- CẤU HÌNH TỌA ĐỘ ---
        // 1. Tọa độ Cửa hàng (Em có thể lấy tọa độ FPT Polytechnic trên Google Maps rồi dán vào đây)
        const storeLat = 10.841328; 
        const storeLng = 106.809975; 

        // 2. Tọa độ Khách hàng (Mô phỏng)
        // Vì mình dùng Free map không có Geocoding (chuyển chữ thành tọa độ), 
        // nên anh sẽ "Mô phỏng" bằng cách lấy tọa độ cửa hàng + một khoảng cách ngẫu nhiên nhỏ.
        // Điều này giúp bản đồ luôn hiện ra 2 điểm gần nhau để demo cho đẹp.
        const randomOffsetLat = (Math.random() - 0.5) * 0.04; // Cách khoảng 2-3km
        const randomOffsetLng = (Math.random() - 0.5) * 0.04;
        
        const custLat = storeLat + randomOffsetLat;
        const custLng = storeLng + randomOffsetLng;

        // --- KHỞI TẠO BẢN ĐỒ ---
        var map = L.map('map').setView([storeLat, storeLng], 13);

        // Thêm lớp nền bản đồ (OpenStreetMap - Miễn phí vĩnh viễn)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap'
        }).addTo(map);

        // --- TẠO ICON ---
        // Icon Cửa hàng (Màu đỏ)
        var storeIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });

        // Icon Khách hàng (Màu xanh - Mặc định)
        var userIcon = new L.Icon.Default();

        // --- ĐÁNH DẤU VỊ TRÍ ---
        var markerStore = L.marker([storeLat, storeLng], {icon: storeIcon}).addTo(map)
            .bindPopup("<b>NIKE STORE</b><br>Kho xuất hàng (Thủ Đức)").openPopup();

        var addressText = document.getElementById("customer-address").innerText;
        var markerCust = L.marker([custLat, custLng], {icon: userIcon}).addTo(map)
            .bindPopup("<b>Khách hàng</b><br>" + addressText);

        // --- VẼ ĐƯỜNG NỐI (Mô phỏng đường đi) ---
        var latlngs = [
            [storeLat, storeLng],
            [custLat, custLng]
        ];
        var polyline = L.polyline(latlngs, {
            color: 'black',       // Màu đen theo phong cách Nike
            weight: 3,            // Độ dày
            opacity: 0.7,
            dashArray: '10, 10',  // Đường nét đứt
            lineCap: 'round'
        }).addTo(map);

        // Tự động Zoom để thấy hết cả 2 điểm
        map.fitBounds(polyline.getBounds(), {padding: [50, 50]});
    });
</script>

</body>
</html>